------------- PostgreSQL -----------------------

https://www.youtube.com/watch?v=Tn67kCaLElk&list=PLwxrtuGg5dNGv4jvDY3TEddn2HIn4-uF9

https://www.youtube.com/watch?v=LA17bOvN-yg&list=PLwxrtuGg5dNGv4jvDY3TEddn2HIn4-uF9&index=2

Installation Directory: C:\Program Files\PostgreSQL\17
Server Installation Directory: C:\Program Files\PostgreSQL\17
Data Directory: C:\Program Files\PostgreSQL\17\data
Database Port: 5432
Database Superuser: postgres
Operating System Account: NT AUTHORITY\NetworkService
Database Service: postgresql-x64-17
Command Line Tools Installation Directory: C:\Program Files\PostgreSQL\17
pgAdmin4 Installation Directory: C:\Program Files\PostgreSQL\17\pgAdmin 4
Stack Builder Installation Directory: C:\Program Files\PostgreSQL\17
Installation Log: C:\Users\oline\AppData\Local\Temp\install-postgresql.log

user postgres/postgres



------------- Step 1 : Installing PostgreSQL on Linux

You can see installation steps on postgresql site : https://www.postgresql.org/download/linux/redhat/

Summary below :

	yum install https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86 64/pgdg-redhat-repo-latest.noarch.rpm
	yum install postgresql12			-- client
	yum install postgresql12-server
	/usr/pgsql-12/bin/postgresql-12-setup initdb	-- Initialize the db
	systemctl enable postgresql-12					-- Allow postgresql start when system restarts
	systemctl start postgresql-12
	systemctl status postgresql-12

------------- Step 2 :  USING POSTGRESQL ROLE

The installation procedure created a user account called postgres that is associated with the default Postgres role.

SWITCH to POSTGRES ACCOUNT
#sudo iu postgres

You can now access a Postgres prompt by typing below command:

$psql
postgres# \du 	: displays all roles available
postgres# \q	: to exit psql

------------- Step 3 : CREATING A NEW NON DEFAULT ROLE.

You have the postgres role configured within the database.
You can create new roles from the command line with the createrole command. 
The-interactive flag will prompt you for the name of the new role and also ask whether it should have superuser permissions.

If you are logged in as the postgres account. createuser-interactive :
$sudo -u postgres createuser --interactive


---------- MANAGING TABLESPACES --------------------------------

pg_default :tablespace stores all user data.
pg_global : tablespace stores all global data (dictionnaire)

---------- DEFAULT STORAGE IN POSTGTRESQL

pg_ctl -D data initdb
Is -IF data
pg_ctl -D data start

When you initialize postgre, the Postgres server creates the required files in $PGDATA directory 

The Default Tablespaces

Two tablespaces are automatically created when the database cluster is initialized.

pg_global  : tablespace is used for shared system catalogs.
pg_default : tablespace is the default tablespace for users and also for templatel and template0 databases

--- Creating a new tbs

postgres# create tablespace tbs1 location '/postgres/data/tbs1';
postgres# \db+
Is -l data/pg_tblspc/

Creating Objects :

create database dbl tablespace tbs1;
\c dbl					-- Switch to db : db1

create table tabl (a int);
create table tab2 (a int) tablespace tbs2;
create table tab3 (a int) tablespace pg_default;

---- Demo 

Initialize an instance :

$ sudo su - postgres
$ mkdir -p /postgres/data/instancel
$ pg_ctl -D /postgres/data/instancel initdb

Start the database server using :

$ pg_ctl -D /postgres/data/instancel
or 
$ pg_ctl -D /postgres/data/instancel -l logfile start

$ pg_ctl -D data initdb
Is -lF data
pg_ctl -D data start

 \db+
    Name    |  Owner   |          Location           | Access privileges | Options |  Size   | Description
------------+----------+-----------------------------+-------------------+---------+---------+-------------
 pg_default | postgres |                             |                   |         | 22 MB   |
 pg_global  | postgres |                             |                   |         | 565 kB  |
 
postgres@OlivierLP:~/16/data$ pwd
/var/lib/postgresql/16/data
postgres@OlivierLP:~/16/data$ psql
psql (16.4 (Ubuntu 16.4-0ubuntu0.24.04.2))
Type "help" for help.

postgres=# create tablespace tbs1 location '/var/lib/postgresql/16/data';
CREATE TABLESPACE

postgres=# \db+
                                            List of tablespaces
    Name    |  Owner   |          Location           | Access privileges | Options |  Size   | Description
------------+----------+-----------------------------+-------------------+---------+---------+-------------
 pg_default | postgres |                             |                   |         | 22 MB   |
 pg_global  | postgres |                             |                   |         | 565 kB  |
 tbs1       | postgres | /var/lib/postgresql/16/data |                   |         | 0 bytes |
(3 rows)

postgres=# exit
postgres@OlivierLP:~/16/data$ ls -ltrh
total 4.0K
drwx------ 2 postgres postgres 4.0K Nov  8 22:33 PG_16_202307071
postgres@OlivierLP:~/16/data$

***** pg_tblspc : folder in $PGDATA where you have symbolic links to tablespaces folders associated with tablespaces 

postgres@OlivierLP:~/16/main$ ls
PG_VERSION  pg_commit_ts  pg_multixact  pg_serial     pg_stat_tmp  pg_twophase  postgresql.auto.conf
base        pg_dynshmem   pg_notify     pg_snapshots  pg_subtrans  pg_wal       postmaster.opts
global      pg_logical    pg_replslot   pg_stat       pg_tblspc    pg_xact      postmaster.pid
postgres@OlivierLP:~/16/main$ cd pg_tblspc
postgres@OlivierLP:~/16/main/pg_tblspc$
postgres@OlivierLP:~/16/main/pg_tblspc$ ls -ltrh
total 0
lrwxrwxrwx 1 postgres postgres 27 Nov  8 22:33 16390 -> /var/lib/postgresql/16/data

NB : l'id pour le nouveau tbs est : 16390

***** Create database with default tbs :

postgres=# create database db1 tablespace tbs1;
postgres=# \l
                                                   List of databases
   Name    |  Owner   | Encoding | Locale Provider | Collate |  Ctype  | ICU Locale | ICU Rules |   Access privileges
-----------+----------+----------+-----------------+---------+---------+------------+-----------+-----------------------
 db1       | postgres | UTF8     | libc            | C.UTF-8 | C.UTF-8 |            |           |
 postgres  | postgres | UTF8     | libc            | C.UTF-8 | C.UTF-8 |            |           |
 template0 | postgres | UTF8     | libc            | C.UTF-8 | C.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |         |         |            |           | postgres=CTc/postgres
 template1 | postgres | UTF8     | libc            | C.UTF-8 | C.UTF-8 |            |           | =c/postgres          +
           |          |          |                 |         |         |            |           | postgres=CTc/postgres
(4 rows)

postgres@OlivierLP:~/16/main/pg_tblspc$ mkdir -p /var/lib/postgresql/16/data/tbs2
postgres=# create tablespace tbs2 location '/var/lib/postgresql/16/data/tbs2';
CREATE TABLESPACE


postgres=#

***** switch to db1 and create tables 

postgres=# \c db1
You are now connected to database "db1" as user "postgres".

db1=# create table tabl (a int);
CREATE TABLE
db1=#

postgres=# \db+
                                              List of tablespaces
    Name    |  Owner   |             Location             | Access privileges | Options |  Size   | Description
------------+----------+----------------------------------+-------------------+---------+---------+-------------
 pg_default | postgres |                                  |                   |         | 22 MB   |
 pg_global  | postgres |                                  |                   |         | 565 kB  |
 tbs1       | postgres | /var/lib/postgresql/16/data      |                   |         | 7568 kB |
 tbs2       | postgres | /var/lib/postgresql/16/data/tbs2 |                   |         | 0 bytes |
(4 rows)

postgres=# create table tab2 (a int) tablespace tbs2;
CREATE TABLE
postgres=# create table tab3 (a int) tablespace pg_default;
CREATE TABLE
postgres=# \db+
                                                List of tablespaces
    Name    |  Owner   |             Location             | Access privileges | Options |    Size    | Description
------------+----------+----------------------------------+-------------------+---------+------------+-------------
 pg_default | postgres |                                  |                   |         | 22 MB      |
 pg_global  | postgres |                                  |                   |         | 565 kB     |
 tbs1       | postgres | /var/lib/postgresql/16/data      |                   |         | 7568 kB    |
 tbs2       | postgres | /var/lib/postgresql/16/data/tbs2 |                   |         | 4096 bytes |
(4 rows)

postgres=#

***** ******** How to move objects from one tablespace to another

NB: There will be a lock on the table while moving to another tbs

alter table tabl set tablespace pg_default;
alter table all in tablespace tbs1 set tablespace pg_default;

*********** Tablespace Properties

alter tablespace space2 set (seq_page_cost=0.5, random_page_cost=0.5);   -- No tested : Need to check further

*********** Set default tablespace for users

postgres=# SET default_tablespace = tbs2;
SET
postgres=# show default_tablespace ;
 default_tablespace
--------------------
 tbs2
(1 row)

postgres=# create table foo (i int);
CREATE TABLE
postgres=# select * from pg_tables where tablename='foo';
 schemaname | tablename | tableowner | tablespace | hasindexes | hasrules | hastriggers | rowsecurity
------------+-----------+------------+------------+------------+----------+-------------+-------------
 public     | foo       | postgres   | tbs2       | f          | f        | f           | f
(1 row)

postgres=# select relname,reltablespace from pg_class where reltablespace in(select
oid from pg_tablespace where spcname not in ('pg_default','pg_global'));
 relname | reltablespace
---------+---------------
 tab2    |         16397
 foo     |         16397
 tab1    |         16390
(3 rows)

postgres=# select * from pg_tablespace;
  oid  |  spcname   | spcowner | spcacl | spcoptions
-------+------------+----------+--------+------------
  1663 | pg_default |       10 |        |
  1664 | pg_global  |       10 |        |
 16390 | tbs1       |       10 |        |
 16397 | tbs2       |       10 |        |
(4 rows)

postgres=# select  relname,reltablespace from pg_class where relname like 'tab%';
      relname      | reltablespace
-------------------+---------------
 tab1              |         16390
 tab2              |         16397
 tab3              |             0
 table_constraints |             0
 table_privileges  |             0
 tables            |             0
(6 rows)

***********  How to Backup additional tablespace

pg_basebackup --format=p --tablespace-mapping=/tmp/space2=/tmp/space2backup -D plainb

*********** Why is tablespace is used for

- Database growing then create a new tablespace and move objects from existing to new tablespace. 
- High perfomrming disk move indexes and table to that

------------- How to change data directory

***********  STEP 1 - Checkout existing data folder

postgres=# show data_directory;
       data_directory
-----------------------------
 /var/lib/postgresql/16/main
(1 row)

postgres=#

New datadir location: /postgres/data

***********  STEP 2 - SHUTDOWN POSTGRES SERVICE.
Depending on postgresql installed :

sudo systemctl status postgresql-12    
sudo systemctl stop postgresql-12 
sudo systemctl status postgresql-12

or 

If postgre user already in sudoers, no need to add sudo at the beginning :

$ service postgresql status
$ service postgresql stop
$ service postgresql status

***********  STEP 3 Copy/move data from current data directory to new location.

#chown postgres: postgres /postgres/data 
$chmod -R 750/postgres/data

cd /var/lib/pgsql/12/data/ 
cp -r*/postgres/data cd /postgres/data
ls -lrt

***********  Step 4 Update New Data dir Location in config file. ***

cp/var/lib/pgsql/12/data/postgresql.conf /var/lib/pgsql/12/data/postgresql.conf_orig

sudo vi /var/lib/pgsql/12/data/postgresql.conf

data_directory = '/postgres/data/'

***********  Step 5 Restarting Postgres ***********  

sudo systemctl start postgresql-12
sudo systemctl status postgresql-12

or 

$ service postgresql stop
$ service postgresql status

tail -10f /var/log/messages

***********  Step 6 Verify new location ***

sudo u postgres psql 
SHOW data_directory;

postgres=# SHOW data_directory; 
data_directory
/postgres/data (1 row)

----------------- Introduction to PostgreSQL log_statement

Its' related with error and reporting to error alongwith warning and database queries in a logfile.

Default log statement option in PostgreSQL configuration file is none which means nothing will be logged in into the error file.

Options

NONE
DDL
MOD
ALL

How does How log_statement work in PostgreSQL?

It's a useful parameter in PostgreSQL used for log error in logfile, database warning message and SQL queries.

Log_statement have four options available in PostgreSQL as mentioned below.

None:

This option of log_statement is defined as doesn't log any query in error log file. This is default configurations option of log_statement 
is available. This is also defined as turning off the log_statement parameter for postgresql.

DDL:

Log all query which are under category of the DDL statement. E.g create, alter and drop statement.

A11:

This option is defined as log all the statement which was executed from user.

It is logging DDL, DML and all the query language in PostgreSQL.

Mod:

Not advised

This option in log_statement is defined as log DDL query as well as log the modifying statement like delete, update, truncate, insert, copy, 
execute and prepar

postgres=# show config_file;
               config_file
-----------------------------------------
 /etc/postgresql/16/main/postgresql.conf
(1 row)

postgres@OlivierLP:~$ cp /etc/postgresql/16/main/postgresql.conf /etc/postgresql/16/main/postgresql.conf.bak
postgres@OlivierLP:~$ vi /etc/postgresql/16/main/postgresql.conf

postgres=# show log_statement;
 log_statement
---------------
 none
(1 row)

postgres=# alter system set log_statement='DDL';
ALTER SYSTEM
postgres=#

$ sudo service postgresql stop
$ sudo service postgresql start
$ sudo service postgresql status

$psql
postgres=# show log_statement;
 log_statement
---------------
 ddl
(1 row)

In ubuntu, destination log file is in : /var/log/postgresql  (alert log file)

$ cd /var/log/postgresql
$ tail -10f postgresql-16-main.log

db1=# CREATE TABLE course ( course_no integer,name text,price numeric);
CREATE TABLE
db1=# INSERT INTO course (course_no, name, price) VALUES (1, 'postgres', 150), (2, 'mysql', 160), (3, 'mongodb', 170);
INSERT 0 3
db1=# show log_destination ;
 log_destination
-----------------
 stderr
(1 row)

db1=# SELECT  pg_current_logfile();
 pg_current_logfile
--------------------

(1 row)

db1=# SHOW log_directory;
 log_directory
---------------
 log
(1 row)

db1=# select * from course;
 course_no |   name   | price
-----------+----------+-------
         1 | postgres |   150
         2 | mysql    |   160
         3 | mongodb  |   170
(3 rows)

db1=#

db1=# alter system set log_statement = 'ALL';
ALTER SYSTEM
db1=# show log_statement;
 log_statement
---------------
 ddl
(1 row)

--- Need to bounce the system to see change applied and all statements will be captured in log file

# delete * from course;




















